# 聚类简介

聚类就是分类

对象之间的距离是聚类的度量衡：类内距离最小化，类间距离最大化。

一般是欧氏距离（直线距离），也可以是曼哈顿距离、切比雪夫距离等

如下图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_145539.jpg)

#### R中计算距离的方法

欧氏距离dist(数据矩阵)

曼哈顿距离dist(数据矩阵，method="manhattan")

切比雪夫距离dist(数据矩阵，method="maximum")

```R
> x1<-c(1,2)
> x2<-c(3,4)
> rbind(x1,x2)
   [,1] [,2]
x1    1    2
x2    3    4
> dist(rbind(x1,x2))
         x1
x2 2.828427
> x3<-c(5,6)
> x4<-c(7,8)
> dist(rbind(x1,x2,x3,x4))
         x1       x2       x3
x2 2.828427                  
x3 5.656854 2.828427         
x4 8.485281 5.656854 2.828427
> dist(rbind(x1,x2,x3,x4),method="manhattan")
   x1 x2 x3
x2  4      
x3  8  4   
x4 12  8  4
> dist(rbind(x1,x2,x3,x4),method="maximum")
   x1 x2 x3
x2  2      
x3  4  2   
x4 
```

## 聚类入门--系统聚类法（层次聚类）

系统聚类法：层数越往上，类别越少。

这种算法只适合于数据量较少的情况使用，因为样本越多，计算代价越大。

大概如下图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_164554.jpg)

#### R中使用系统聚类法建模

准备数据框数据集-->更改行号(rownames)-->计算每个点之间的距离-->建立系统聚类模型(hclust)-->画出模型图(plot)-->具体聚类函数(rect.hclust(model,具体几类))

```R
> city<-read.table("city.txt",header=T)
> city
        x1     x2     x3     x4     x5      x6      x7     x8
1  2959.19 730.79 749.41 513.34 467.87 1141.82  478.42 457.64
2  2459.77 495.47 697.33 302.87 284.19  735.97  570.84 305.08
3  1495.63 515.90 362.37 285.32 272.95  540.58  364.91 188.63
4  1046.33 477.77 290.15 208.57 201.50  414.72  281.84 212.10
5  1303.97 524.29 254.83 192.17 249.81  463.09  287.87 192.96
6  1730.84 553.90 246.91 279.81 239.18  445.20  330.24 163.86
7  1561.86 492.42 200.49 218.36 220.69  459.62  360.48 147.76
8  1410.11 510.71 211.88 277.11 224.65  376.82  317.61 152.85
9  3712.31 550.74 893.37 346.93 527.00 1034.98  720.33 462.03
10 2629.16 557.32 689.73 435.69 514.66  795.87  575.76 323.36
11 1844.78 430.29 271.28 126.33 250.56  513.18  314.00 151.39
12 2709.46 428.11 334.12 160.77 405.14  461.67  535.13 232.29
13 1563.78 303.65 233.81 107.90 209.70  393.99  509.39 160.12
14 1675.75 613.32 550.71 219.79 272.59  599.43  371.62 211.84
15 1427.65 431.79 288.55 208.14 217.00  337.76  421.31 165.32
16 1783.43 511.88 282.84 201.01 237.60  617.74  523.52 182.52
17 1942.23 512.27 401.39 206.06 321.29  697.22  492.60 226.45
18 3055.17 353.23 564.56 356.27 811.88  873.06 1082.82 420.81
19 2033.87 300.82 338.65 157.78 329.06  621.74  587.02 218.27
20 2057.86 186.44 202.72 171.79 329.65  477.17  312.93 279.19
21 2303.29 589.99 516.21 236.55 403.92  730.05  438.41 225.80
22 1974.28 507.76 344.79 203.21 240.24  575.10  430.36 223.46
23 1673.82 437.75 461.61 153.32 254.66  445.59  346.11 191.48
24 2194.25 537.01 369.07 249.54 290.84  561.91  407.70 330.95
25 2646.61 839.70 204.44 209.11 379.30  371.04  269.59 389.33
26 1472.95 390.89 447.95 259.51 230.61  490.90  469.10 191.34
27 1525.57 472.98 328.90 219.86 206.65  449.69  249.66 228.19
28 1654.69 437.77 258.78 303.00 244.93  479.53  288.56 236.51
29 1375.46 480.99 273.84 317.32 251.08  424.75  228.73 195.93
30 1608.82 536.05 432.46 235.82 250.28  541.30  344.85 214.40
> rownames(city)<-c("北京","天津","河北","山西","内蒙古","辽宁","吉林","黑龙江","上海","浙江","安徽","福建","江西","山东","河南","湖北","湖南","广东","广西","海南","重庆","四川","贵州","云南","西藏","陕西","甘肃","青海","宁夏","新疆")
> city
            x1     x2     x3     x4     x5      x6      x7     x8
北京   2959.19 730.79 749.41 513.34 467.87 1141.82  478.42 457.64
天津   2459.77 495.47 697.33 302.87 284.19  735.97  570.84 305.08
河北   1495.63 515.90 362.37 285.32 272.95  540.58  364.91 188.63
山西   1046.33 477.77 290.15 208.57 201.50  414.72  281.84 212.10
内蒙古 1303.97 524.29 254.83 192.17 249.81  463.09  287.87 192.96
辽宁   1730.84 553.90 246.91 279.81 239.18  445.20  330.24 163.86
吉林   1561.86 492.42 200.49 218.36 220.69  459.62  360.48 147.76
黑龙江 1410.11 510.71 211.88 277.11 224.65  376.82  317.61 152.85
上海   3712.31 550.74 893.37 346.93 527.00 1034.98  720.33 462.03
浙江   2629.16 557.32 689.73 435.69 514.66  795.87  575.76 323.36
安徽   1844.78 430.29 271.28 126.33 250.56  513.18  314.00 151.39
福建   2709.46 428.11 334.12 160.77 405.14  461.67  535.13 232.29
江西   1563.78 303.65 233.81 107.90 209.70  393.99  509.39 160.12
山东   1675.75 613.32 550.71 219.79 272.59  599.43  371.62 211.84
河南   1427.65 431.79 288.55 208.14 217.00  337.76  421.31 165.32
湖北   1783.43 511.88 282.84 201.01 237.60  617.74  523.52 182.52
湖南   1942.23 512.27 401.39 206.06 321.29  697.22  492.60 226.45
广东   3055.17 353.23 564.56 356.27 811.88  873.06 1082.82 420.81
广西   2033.87 300.82 338.65 157.78 329.06  621.74  587.02 218.27
海南   2057.86 186.44 202.72 171.79 329.65  477.17  312.93 279.19
重庆   2303.29 589.99 516.21 236.55 403.92  730.05  438.41 225.80
四川   1974.28 507.76 344.79 203.21 240.24  575.10  430.36 223.46
贵州   1673.82 437.75 461.61 153.32 254.66  445.59  346.11 191.48
云南   2194.25 537.01 369.07 249.54 290.84  561.91  407.70 330.95
西藏   2646.61 839.70 204.44 209.11 379.30  371.04  269.59 389.33
陕西   1472.95 390.89 447.95 259.51 230.61  490.90  469.10 191.34
甘肃   1525.57 472.98 328.90 219.86 206.65  449.69  249.66 228.19
青海   1654.69 437.77 258.78 303.00 244.93  479.53  288.56 236.51
宁夏   1375.46 480.99 273.84 317.32 251.08  424.75  228.73 195.93
新疆   1608.82 536.05 432.46 235.82 250.28  541.30  344.85 214.40
> model.hclust<-hclust(dist(city))
> plot(model.hclust)
> rect.hclust(model.hclust,5)

```

模型图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_171015.jpg)

指定分类模型图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_171053.jpg)

在样本量的情况下，层次越多，计算代价越大。生产情况下一般不适用系统聚类法(分层)，下面学习K-Means算法。

# K-Means聚类算法

K-Means是一种随机算法--意味着需要迭代才能够收敛。

### K-Means算法过程

①从N样本数据中随机选择K个对象作为初始聚类中心（这里是分为K类）

②分别计算每个样本到各个聚类中心的距离，将对象分配到距离最近的聚类中

​		如下图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_180323.jpg)

③分配完对象之后重新计算K个聚类的中心 （这里是求每个聚类的平均值）

​		如下图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_180717.jpg)

④计算和上一次聚类中心的距离，如果差异很大，说明算法没有收敛，则需要继续迭代。直至

质心相等或者小于指定阈值。算法收敛

​		质心不相等如下图：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-07_182041.jpg)

### R中使用K-Means聚类算法建模

数据框数据集-->建立模型kmeans(数据集，分类的个数，迭代的次数)-->查看模型-->对模型进行排序（sort）

```R
> city
            x1     x2     x3     x4     x5      x6      x7     x8
北京   2959.19 730.79 749.41 513.34 467.87 1141.82  478.42 457.64
天津   2459.77 495.47 697.33 302.87 284.19  735.97  570.84 305.08
河北   1495.63 515.90 362.37 285.32 272.95  540.58  364.91 188.63
山西   1046.33 477.77 290.15 208.57 201.50  414.72  281.84 212.10
内蒙古 1303.97 524.29 254.83 192.17 249.81  463.09  287.87 192.96
辽宁   1730.84 553.90 246.91 279.81 239.18  445.20  330.24 163.86
吉林   1561.86 492.42 200.49 218.36 220.69  459.62  360.48 147.76
黑龙江 1410.11 510.71 211.88 277.11 224.65  376.82  317.61 152.85
上海   3712.31 550.74 893.37 346.93 527.00 1034.98  720.33 462.03
浙江   2629.16 557.32 689.73 435.69 514.66  795.87  575.76 323.36
安徽   1844.78 430.29 271.28 126.33 250.56  513.18  314.00 151.39
福建   2709.46 428.11 334.12 160.77 405.14  461.67  535.13 232.29
江西   1563.78 303.65 233.81 107.90 209.70  393.99  509.39 160.12
山东   1675.75 613.32 550.71 219.79 272.59  599.43  371.62 211.84
河南   1427.65 431.79 288.55 208.14 217.00  337.76  421.31 165.32
湖北   1783.43 511.88 282.84 201.01 237.60  617.74  523.52 182.52
湖南   1942.23 512.27 401.39 206.06 321.29  697.22  492.60 226.45
广东   3055.17 353.23 564.56 356.27 811.88  873.06 1082.82 420.81
广西   2033.87 300.82 338.65 157.78 329.06  621.74  587.02 218.27
海南   2057.86 186.44 202.72 171.79 329.65  477.17  312.93 279.19
重庆   2303.29 589.99 516.21 236.55 403.92  730.05  438.41 225.80
四川   1974.28 507.76 344.79 203.21 240.24  575.10  430.36 223.46
贵州   1673.82 437.75 461.61 153.32 254.66  445.59  346.11 191.48
云南   2194.25 537.01 369.07 249.54 290.84  561.91  407.70 330.95
西藏   2646.61 839.70 204.44 209.11 379.30  371.04  269.59 389.33
陕西   1472.95 390.89 447.95 259.51 230.61  490.90  469.10 191.34
甘肃   1525.57 472.98 328.90 219.86 206.65  449.69  249.66 228.19
青海   1654.69 437.77 258.78 303.00 244.93  479.53  288.56 236.51
宁夏   1375.46 480.99 273.84 317.32 251.08  424.75  228.73 195.93
新疆   1608.82 536.05 432.46 235.82 250.28  541.30  344.85 214.40
> model.km<-kmeans(city,5,nstart=20)
> model.km
K-means clustering with 5 clusters of sizes 7, 5, 2, 1, 15

Cluster means:
        x1       x2       x3      x4       x5        x6        x7       x8
1 1975.814 426.6386 315.8200 187.960 285.6057  580.5800  438.3043 230.3186
2 2549.658 582.1180 488.3660 268.998 397.4420  618.9200  477.9460 295.1720
3 3335.750 640.7650 821.3900 430.135 497.4350 1088.4000  599.3750 459.8350
4 3055.170 353.2300 564.5600 356.270 811.8800  873.0600 1082.8200 420.8100
5 1501.815 478.6787 322.8827 232.400 236.4187  457.5313  344.8187 190.2193

Clustering vector:
  北京   天津   河北   山西 内蒙古   辽宁   吉林 黑龙江   上海   浙江 
     3      2      5      5      5      5      5      5      3      2 
  安徽   福建   江西   山东   河南   湖北   湖南   广东   广西   海南 
     1      2      5      5      5      1      1      4      1      1 
  重庆   四川   贵州   云南   西藏   陕西   甘肃   青海   宁夏   新疆 
     2      1      5      1      2      5      5      5      5      5 

Within cluster sum of squares by cluster:
[1] 385650.4 698464.2 360737.7      0.0 873285.0
 (between_SS / total_SS =  84.6 %)

Available components:

[1] "cluster"      "centers"      "totss"        "withinss"    
[5] "tot.withinss" "betweenss"    "size"         "iter"        
[9] "ifault"      
> sort(model.km$cluster)
  安徽   湖北   湖南   广西   海南   四川   云南   天津   浙江   福建 
     1      1      1      1      1      1      1      2      2      2 
  重庆   西藏   北京   上海   广东   河北   山西 内蒙古   辽宁   吉林 
     2      2      3      3      4      5      5      5      5      5 
黑龙江   江西   山东   河南   贵州   陕西   甘肃   青海   宁夏   新疆 
     5      5      5      5      5      5      5      5      5      5 

```

### K-Means算法例子一

##### 客户价值识别案例

通过客户的聚类，区分无价值客户、高价值客户。

识别客户价值应用最广泛的业务模型RFM模型，R：最近消费时间间隔；F：消费频率；M：消费金额；

业务模型RFM的建模

```R
> data<-read.table("rfm.txt",header=T)
> data
  id  R  F    M
1  1 15  3  800
2  2  4 16 2000
3  3 13  4  700
4  4 12  3  500
5  5  3 15 1500
6  6  5 14 2200
7  7  4  5 1800
> model.hclust<-hclust(dist(data))
> plot(model.hclust)
```

画出系统聚类法的图像：

![](https://github.com/user-wbgithub/R/blob/master/images/2020-02-09_115623.jpg)

```R
> data<-read.table("rfm.txt",header=T)
> data
  id  R  F    M
1  1 15  3  800
2  2  4 16 2000
3  3 13  4  700
4  4 12  3  500
5  5  3 15 1500
6  6  5 14 2200
7  7  4  5 1800
> model.km<-kmeans(data,2,nstart=20)
> model.km
K-means clustering with 2 clusters of sizes 3, 4

Cluster means:
        id        R         F         M
1 2.666667 13.33333  3.333333  666.6667
2 5.000000  4.00000 12.500000 1875.0000

Clustering vector:
[1] 1 2 1 1 2 2 2

Within cluster sum of squares by cluster:
[1]  46676.67 267593.00
 (between_SS / total_SS =  88.8 %)

Available components:

[1] "cluster"      "centers"      "totss"        "withinss"    
[5] "tot.withinss" "betweenss"    "size"         "iter"        
[9] "ifault"      

```

K-Means建模迭代20次分为2个模型，模型1R值很高表明频率很高，F值很低表示间隔短

，2模型R值很小表明频率很低，F值很高表明间隔久。表明2模型用户为高价值客户。

### K-Means建模案例二

##### 航空公司客户价值分析案例

航空信息属性表的一部分数据

MEMBER_NO	FFP_DATE	FIRST_FLIGHT_DATE	GENDER	FFP_TIER	WORK_CITY	WORK_PROVINCE	WORK_COUNTRY	AGE	LOAD_TIME	FLIGHT_COUNT	BP_SUM	EP_SUM_YR_1	EP_SUM_YR_2	SUM_YR_1	SUM_YR_2	SEG_KM_SUM	WEIGHTED_SEG_KM	LAST_FLIGHT_DATE	AVG_FLIGHT_COUNT	AVG_BP_SUM	BEGIN_TO_FIRST	LAST_TO_END	AVG_INTERVAL	MAX_INTERVAL	ADD_POINTS_SUM_YR_1	ADD_POINTS_SUM_YR_2	EXCHANGE_COUNT	avg_discount	P1Y_Flight_Count	L1Y_Flight_Count	P1Y_BP_SUM	L1Y_BP_SUM	EP_SUM	ADD_Point_SUM	Eli_Add_Point_Sum	L1Y_ELi_Add_Points	Points_Sum	L1Y_Points_Sum	Ration_L1Y_Flight_Count	Ration_P1Y_Flight_Count	Ration_P1Y_BPS	Ration_L1Y_BPS	Point_NotFlight
54993	2006/11/2	2008/12/24	男	6	.	北京	CN	31	2014/3/31	210	505308	0	74460	239560	234188	580717	558440.14	2014/3/31	26.25	63163.5	2	1	3.483253589	18	3352	36640	34	0.961639043	103	107	246197	259111	74460	39992	114452	111100	619760	370211	0.50952381	0.49047619	0.487220691	0.51277733	50

字段对应的属性

| **属性中文**                                                | **属性英文**            |                           **备注**                           |
| ----------------------------------------------------------- | ----------------------- | :----------------------------------------------------------: |
| 会员卡号                                                    | MEMBER_NO               |                                                              |
| 入会时间                                                    | FFP_DATE                |                    办理会员卡的开始的时间                    |
| 第一次飞行日期                                              | FIRST_FLIGHT_DATE       |                                                              |
| 性别                                                        | GENDER                  |                                                              |
| 会员卡级别                                                  | FFP_TIER                |                                                              |
| 工作地城市                                                  | WORK_CITY               |                                                              |
| 工作地所在省份                                              | WORK_PROVINCE           |                                                              |
| 工作地所在国家                                              | WORK_COUNTRY            |                                                              |
| 年龄                                                        | age                     |                                                              |
| 观测窗口的结束时间                                          | LOAD_TIME               |           选取样本的时间宽度，距离现在最近的时间。           |
| **飞行次数**                                                | FLIGHT_COUNT            |                             频数                             |
| 观测窗口总基本积分                                          | BP_SUM                  | 航空公里的里程就相当于积分，积累一定分数可以兑换奖品和免费里程。 |
| 第一年精英资格积分                                          | EP_SUM_YR_1             |                                                              |
| 第二年精英资格积分                                          | EP_SUM_YR_2             |                                                              |
| 第一年总票价                                                | SUM_YR_1                |                                                              |
| 第二年总票价                                                | SUM_YR_2                |                                                              |
| 观测窗口总飞行公里数                                        | SEG_KM_SUM              |                                                              |
| 观测窗口总加权飞行公里数（Σ舱位折扣×航段距离）              | WEIGHTED_SEG_KM         |                                                              |
| 末次飞行日期                                                | LAST_FLIGHT_DATE        |                       最后一次飞行时间                       |
| 观测窗口季度平均飞行次数                                    | AVG_FLIGHT_COUNT        |                                                              |
| 观测窗口季度平均基本积分累积                                | AVG_BP_SUM              |                                                              |
| 观察窗口内第一次乘机时间至MAX（观察窗口始端，入会时间）时长 | BEGIN_TO_FIRST          |                                                              |
| 最后一次乘机时间至观察窗口末端时长                          | LAST_TO_END             |                                                              |
| 平均乘机时间间隔                                            | AVG_INTERVAL            |                                                              |
| 观察窗口内最大乘机间隔                                      | MAX_INTERVAL            |                                                              |
| 观测窗口中第1年其他积分（合作伙伴、促销、外航转入等）       | ADD_POINTS_SUM_YR_1     |                                                              |
| 观测窗口中第2年其他积分（合作伙伴、促销、外航转入等）       | ADD_POINTS_SUM_YR_2     |                                                              |
| 积分兑换次数                                                | EXCHANGE_COUNT          |                                                              |
| 平均折扣率                                                  | avg_discount            |                                                              |
| 第1年乘机次数                                               | P1Y_Flight_Count        |                                                              |
| 第2年乘机次数                                               | L1Y_Flight_Count        |                                                              |
| 第1年里程积分                                               | P1Y_BP_SUM              |                                                              |
| 第2年里程积分                                               | L1Y_BP_SUM              |                                                              |
| 观测窗口总精英积分                                          | EP_SUM                  |                                                              |
| 观测窗口中其他积分（合作伙伴、促销、外航转入等）            | ADD_Point_SUM           |                                                              |
| 非乘机积分总和                                              | Eli_Add_Point_Sum       |                                                              |
| 第2年非乘机积分总和                                         | L1Y_ELi_Add_Points      |                                                              |
| 总累计积分                                                  | Points_Sum              |                                                              |
| 第2年观测窗口总累计积分                                     | L1Y_Points_Sum          |                                                              |
| 第2年的乘机次数比率                                         | Ration_L1Y_Flight_Count |                                                              |
| 第1年的乘机次数比率                                         | Ration_P1Y_Flight_Count |                                                              |
| 第1年里程积分占最近两年积分比例                             | Ration_P1Y_BPS          |                                                              |
| 第2年里程积分占最近两年积分比例                             | Ration_L1Y_BPS          |                                                              |
| 非乘机的积分变动次数                                        | Point_NotFlight         |                                                              |

针对航空公司基于RFM模型建立LRFMC模型

| 模型  | L（入会时长）                    | R(消费间隔）                                 | F（消费频率）                      | M（消费金额）                  | C（折扣系数）                                    |
| ----- | -------------------------------- | -------------------------------------------- | ---------------------------------- | ------------------------------ | ------------------------------------------------ |
| LRFMC | 会员入会时间距观测窗口结束的月数 | 客户最近一次乘坐公司飞机距观测窗口结束的月数 | 客户在观测窗口内乘坐公司飞机的次数 | 客户在观测窗口内累计的飞行里程 | 客户在观测窗口内乘坐舱位所对应的折扣系数的平均值 |

每个指标从原始数据中的计算

**L**=LOAD_TIME-FFP_DATE

**R**=LOAD_TIME-LAST_FLIGHT_DATE

**F**=FLIGHT_COUNT

**M**=SEG_KM_SUM

**C**=AVG_DISCOUNT

针对所建立的模型留下需要的业务字段:

| **属性中文**         | **属性英文**     |                 **备注**                 |
| -------------------- | ---------------- | :--------------------------------------: |
| 入会时间             | FFP_DATE         |          办理会员卡的开始的时间          |
| 观测窗口的结束时间   | LOAD_TIME        | 选取样本的时间宽度，距离现在最近的时间。 |
| **飞行次数**         | FLIGHT_COUNT     |                   频数                   |
| 观测窗口总飞行公里数 | SEG_KM_SUM       |                                          |
| 末次飞行日期         | LAST_FLIGHT_DATE |             最后一次飞行时间             |
| 平均折扣率           | avg_discount     |                                          |

观测数据分析数据，对产生钱、里程、积分等数据进行分析；

```R
 data=read.csv("./air_data.csv",header=T)
> col=c(15:18,20:29)
> summary(data.[,col])
Error in summary(data.[, col]) : 找不到对象'data.'
> summary(data[,col])
    SUM_YR_1         SUM_YR_2        SEG_KM_SUM     WEIGHTED_SEG_KM 
 Min.   :     0   Min.   :     0   Min.   :   368   Min.   :     0  
 1st Qu.:  1003   1st Qu.:   780   1st Qu.:  4747   1st Qu.:  3219  
 Median :  2800   Median :  2773   Median :  9994   Median :  6978  
 Mean   :  5355   Mean   :  5604   Mean   : 17124   Mean   : 12777  
 3rd Qu.:  6574   3rd Qu.:  6846   3rd Qu.: 21271   3rd Qu.: 15300  
 Max.   :239560   Max.   :234188   Max.   :580717   Max.   :558440  
 NA's   :551      NA's   :138                                       
 AVG_FLIGHT_COUNT    AVG_BP_SUM      BEGIN_TO_FIRST   LAST_TO_END   
 Min.   : 0.2500   Min.   :    0.0   Min.   :  0.0   Min.   :  1.0  
 1st Qu.: 0.4286   1st Qu.:  336.0   1st Qu.:  9.0   1st Qu.: 29.0  
 Median : 0.8750   Median :  752.4   Median : 50.0   Median :108.0  
 Mean   : 1.5422   Mean   : 1421.4   Mean   :120.1   Mean   :176.1  
 3rd Qu.: 1.8750   3rd Qu.: 1690.3   3rd Qu.:166.0   3rd Qu.:268.0  
 Max.   :26.6250   Max.   :63163.5   Max.   :729.0   Max.   :731.0  
                                                                    
  AVG_INTERVAL     MAX_INTERVAL ADD_POINTS_SUM_YR_1 ADD_POINTS_SUM_YR_2
 Min.   :  0.00   Min.   :  0   Min.   :     0.0    Min.   :     0.0   
 1st Qu.: 23.37   1st Qu.: 79   1st Qu.:     0.0    1st Qu.:     0.0   
 Median : 44.67   Median :143   Median :     0.0    Median :     0.0   
 Mean   : 67.75   Mean   :166   Mean   :   540.3    Mean   :   814.7   
 3rd Qu.: 82.00   3rd Qu.:228   3rd Qu.:     0.0    3rd Qu.:     0.0   
 Max.   :728.00   Max.   :728   Max.   :600000.0    Max.   :728282.0   
                                                                       
 EXCHANGE_COUNT     avg_discount   
 Min.   : 0.0000   Min.   :0.0000  
 1st Qu.: 0.0000   1st Qu.:0.6120  
 Median : 0.0000   Median :0.7119  
 Mean   : 0.3198   Mean   :0.7216  
 3rd Qu.: 0.0000   3rd Qu.:0.8095  
 Max.   :46.0000   Max.   :1.5000  
                                   

```

通过数据的分析发现：数据中存在票价最小值为0、折扣率为0、飞行里程不为0的数据。

```R
  SUM_YR_1         SUM_YR_2        SEG_KM_SUM     WEIGHTED_SEG_KM 
 Min.   :     0   Min.   :     0   Min.   :   368   Min.   :     0  
```

下面剔除这些数据；

对于原始数据，进行数据的清洗。这里去票价为空、去掉票价为0、折扣率为0、但是飞行总数大于0的记录。

```R
> delet_na<-data[-which(is.na(data$SUM_YR_1))|is.na(data$SUM_YR_2),]
Warning message:
In -which(is.na(data$SUM_YR_1)) | is.na(data$SUM_YR_2) :
  长的对象长度不是短的对象长度的整倍数
> index<-((delet_na$SUM_YR_1==0&delet_na$SUM_YR_2==0))*(delet_na$avg_discount!=0)*(delet_na$SEG_KM_SUM>0)
> deletdata<-delet_na[-which(index==1),]
> cleanefile<-deletdata

```

属性规约，只保留建模所需要的字段

```R
> dt<-data.frame(LOAD_TIME,FFP_DATE,LAST_TO_END,FLIGHT_COUNT,SEG_KM_SUM,avg_discount)
```

**数据转换**：

将数据转换为适当格式，适应挖掘任务以及算法的需要。这里采用的是属性构造和数据**标准化**。

**属性构造**：原始数据中没有，但是建模时需要的数据。利用原始数据构造出需要的数据。

**数据中心化**：是指数据中的各项数据减去数据集的均值

**数据标准化**：是指数据中心化之后的数据再除以数据集的标准差，即数据集中的各项数据减去数据集的均值再除以数据集的标准差

**R语言中可以使用scale方法对数据进行中心化和标准化**。

```R
> # 构造L、R、F、M、C指标
> # 转换为时间格式
> cleanedfile$FFP_DATE <- as.Date(cleanedfile$FFP_DATE)
> cleanedfile$LOAD_TIME <- as.Date(cleanedfile$LOAD_TIME)
> 
> # 构造时间间隔格式
> library(lubridate)  # 处理日期格式数据包
> interval <- interval(cleanedfile$FFP_DATE, cleanedfile$LOAD_TIME)  
> 
> # 以月为单位计算时长，输入为时间间隔
> L <- time_length(interval, 'month')
> L <- round(L, 2)
> 
> R <- cleanedfile$LAST_TO_END
> F <- cleanedfile$FLIGHT_COUNT
> M <- cleanedfile$SEG_KM_SUM
> C <- cleanedfile$avg_discount
> # 数据整合
> airdata <- data.frame(L, R, F, M, C)
> 
> # 数据标准化
> zscoredfile <- scale(airdata)
>
># 数据写出
> write.csv(zscoredfile, './zscoreddata.csv')
>
># 构建模型
> result <- kmeans(zscoredfile,5)
> type<-result$cluster
> table(type)  # 查看类别分布
type
    1     2     3     4     5 
12134 15743  4172  5336 24666 
> 
> centervec <- result$center
> centervec
            L            R           F           M          C
1 -0.31372617  1.685549200 -0.57392324 -0.53674300 -0.1743790
2  1.16065910 -0.377288183 -0.08702249 -0.09485386 -0.1556468
3  0.05489181 -0.002486189 -0.22564054 -0.22966049  2.1967578
4  0.48293634 -0.799448753  2.48351216  2.42472275  0.3087468
5 -0.70021324 -0.415007508 -0.16122066 -0.16111462 -0.2532264
>
```

###### 结果分析：

| **聚类类别** | **聚类个数** | **聚类中心** |              |             |             |            |
| ------------ | ------------ | ------------ | ------------ | ----------- | ----------- | ---------- |
|              |              | **L**        | **R**        | **F**       | **M**       | **C**      |
| 1            | 5336         | 0.48293634   | -0.799448753 | 2.48351216  | 2.42472275  | 0.3087468  |
| 2            | 4172         | 0.05489181   | -0.002486189 | -0.22564054 | -0.22966049 | 2.1967578  |
| 3            | 12134        | -0.31372617  | 1.6855492    | -0.57392324 | -0.536743   | -0.174379  |
| 4            | 24668        | -0.70013177  | -0.415012514 | -0.16123328 | -0.1611224  | -0.2533159 |
| 5            | 15741        | 1.16076786   | -0.377275545 | -0.08699329 | -0.09483324 | -0.1554942 |

1.客户群体1：在R上最大，在F、M属性上最小；

2.客户群体2：在L属性上最大；

3.客户群体3：在C属性上最大；

4.客户群体4：在F、M属性上最大，在R属性上最小；

5.客户群体5：在L、C属性上最小；

###### 客户分析：

重要保持客户：客户在折扣率C高（头等舱），R低、F高/M高。最为理想客户。

重要发展客户：客户在折扣率C高（头等舱），但是L低，注册时间短，对应F、M低。是潜在价值客户。

重要挽留客户：客户在折扣率C、F、M上较高但是，R值由于乘坐时间间隔变久也变高。这类是重要挽留客户。

一般客户：客户在折扣率C、F、M、L上都很低，R也会很高。低价值客户；

###### 所以：

客户群体1：一般客户

客户群体2：重要挽留客户

客户群体3：重要发展客户

客户群体4：重要保持客户

客户群体5：一般客户

###### 模型应用：

根据客户群进行特征分析，采取不同的营销手段，为航空公司的价值客户群提供管理参考。

*1）会员的升级与保级*

*航空公司的会员可以分为白金卡会员、金卡会员、银卡会员、普通卡会员，其中非普通卡会员可以统称为航空公司的精英会员。虽然各个航空公司都有自己的特点和规定，但会员制的管理方法是大同小异的。成为精英会员一般都是要求在一定时间内（如一年）积累一定的飞行里程或航段，达到这种要求后就会在有效期内（通常为两年）成为精英会员，并享受相应的高级别服务。有效期快结束时，根据相关评价方法确定客户是否有资格继续作为精英会员，然后对该客户进行相应地升级或降级。*

*然而，由于许多客户并没有意识到或根本不了解会员升级或保级的时间与要求（相关的文件说明往往复杂且不易理解），经常在评价期过后才发现自己其实只差一点就可以实现升级或保级，却错过了机会，使之前的里程积累白白损失。同时，这种认知还可能导致客户的不满，干脆放弃在本公司的消费。*

*因此，航空公司可以在对会员升级或保级进行评价的时间点之前，对那些接近但尚未达到要求的较高消费客户进行适当提醒甚至采取一些促销活动，刺激他们通过消费达到相应标准。这样既可以获得收益，同时也提高了客户的满意度，增加了公司的精英会员。*

** 

*（2）首次兑换*

*航空公司常旅客计划中最能够吸引客户的内容就是客户可以通过消费积累的里程来兑换免票或免费升舱等。各个航空公司都有一个首次兑换标准，也就是当客户的里程或航段积累到一定程度时才可以实现第一次兑换，这个标准会高于正常的里程兑换标准。但是很多公司的里程积累随着时间会进行一定地削减，如有的公司会在年末对该年积累的里程进行折半处理。这样会导致许多不了解情况的会员白白损失自己好不容易积累的里程，甚至总是难以实现首次兑换。同样，这也会引起客户的不满或流失。可以采取的措施是从数据库中提取出接近但尚未达到首次兑换标准的会员，对他们进行提醒或促销，使他们通过消费达到标准。一旦实现了首次兑换，客户在本公司进行再次消费兑换就比在其他公司进行兑换要容易许多，在一定程度上等于提高了转移的成本。另外，在一些特殊的时间点（如里程折半的时间点）之前可以给客户一些提醒，这样可以增加客户的满意度。*

** 

*（3）交叉销售*

*通过发行联名卡等与非航空类企业的合作，使客户在其他企业的消费过程中获得本公司的积分，增强与公司的联系，提高他们的忠诚度。例如，可以查看重要客户在非航空类合作伙伴处的里程积累情况，找出他们习惯的里程积累方式（是否经常在合作伙伴处消费、更喜欢消费哪些类型合作伙伴的产品），对他们进行相应促销。*

** 

*客户识别期和发展期为客户关系打下基石，但是这两个时期带来的客户关系是短暂的、不稳定的。企业要获取长期的利润，必须具有稳定的、高质量的客户。保持客户对于企业是至关重要的，不仅因为争取一个新客户的成本远远高于维持老客户的成本，更重要的是客户流失会造成公司收益的直接损失。因此，在这一时期，航空公司应该努力维系客户关系水平，使之处于较高的水准，最大化生命周期内公司与客户的互动价值，并使这样的高水平尽可能延长。对于这一阶段的客户，主要应该通过提供优质的服务产品和提高服务水平来提高客户的满意度。通过对常旅客数据库的数据挖掘、进行客户细分，可以获得重要保持客户的名单。这类客户一般所乘航班的平均折扣率（C）较高，最近乘坐过本公司航班（R）低，乘坐的次数（F）或里程（M）也较高。他们是航空公司的价值客户，是最为理想的客户类型，对航空公司的贡献最大，所占比例却比较小。航空公司应该优先将资源投放到他们身上，对他们进行差异化管理和一对一营销，提高这类客户的忠诚度与满意度，尽可能延长这类客户的高水平消费。*

